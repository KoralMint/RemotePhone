<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アプリケーション設定</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="app-header">
                <div class="app-title">RemotePhone</div>
                <div class="app-subtitle">設定</div>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" data-section="home">🏠 ホーム</button>
                <button class="nav-item" data-section="connect">📲 デバイスを接続する</button>
                <button class="nav-item" data-section="customize">🛠️ カスタマイズ</button>
                <button class="nav-item" data-section="settings">⚙️ 設定</button>
                <button class="nav-item" data-section="release">📝 リリースノート</button>
            </nav>
        </div>

        <main class="main-content">
            <!-- ホーム -->
            <section class="content-section active" id="home">
                <h1 class="section-title">🏠 ホーム</h1>

                <div class="home-grid">
                    <!-- デバイス接続状態 -->
                    <div class="card main-device-status">
                        <h3 class="card-title">デバイス接続状態</h3>
                        <div id="device-connection-status">
                            <!-- 未接続状態 -->
                            <div class="connection-status disconnected" id="disconnected-state">
                                <div class="status-text inactive">接続されていません</div>
                                <div class="connect-action">
                                    <button class="btn btn-primary connect-btn"
                                        onclick="showConnectSection()">デバイスを接続する</button>
                                </div>
                            </div>

                            <!-- 接続中状態 -->
                            <div class="connection-status connected" id="connected-state" style="display: none;">
                                <div class="status-text active">接続中</div>
                                <div class="device-info">
                                    <div class="device-name">iPhone 15 Pro</div>
                                    <div class="rtt-status">
                                        <span class="rtt-label">RTT:</span>
                                        <span class="rtt-value stable">安定</span>
                                    </div>
                                    <div class="connection-time">接続時間: 00:15:32</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- サーバー接続状況 -->
                    <div class="card server-status">
                        <h3 class="card-title">サーバー接続状況</h3>
                        <div class="server-info">
                            <div class="status-indicator">
                                <span class="status-dot status-normal"></span>
                                <span class="status-text">正常</span>
                            </div>
                            <p class="server-note">
                                Wi-Fiの切り替えなどにより、サービスが正常に動作しない可能性がございます。サービスが正常に動作しない場合は再起動してください。
                            </p>
                        </div>
                    </div>

                    <!-- 接続方法 -->
                    <div class="card connection-method">
                        <h3 class="card-title">接続方法</h3>
                        <div class="method-options">
                            <div class="method-option selected">
                                <div class="method-name">WebSocket</div>
                                <div class="method-description">Wi-Fiを使用した高速な手段</div>
                            </div>
                            <div class="method-option disabled">
                                <div class="method-name">Bluetooth</div>
                                <div class="method-description">最短距離で最速、かつ安全</div>
                            </div>
                            <div class="method-option">
                                <div class="method-name">WebRTC</div>
                                <div class="method-description">安全で、遠く離れても利用可能</div>
                            </div>
                        </div>
                    </div>

                    <!-- 空のスペース -->
                    <div class="card empty-space">
                        <!-- 将来の機能用 -->
                    </div>
                </div>
            </section>

            <!-- デバイスを接続する -->
            <section class="content-section" id="connect">
                <h1 class="section-title">📲 デバイスを接続する</h1>

                <div class="card">
                    <h3 class="card-title">ワンタイムパスキー</h3>
                    <div class="passkey-section">
                        <div class="large-passkey" id="large-passkey">0000</div>
                        <div class="passkey-timer-large">
                            <div class="timer-bar-large">
                                <div class="timer-progress-large" id="timer-progress-large"></div>
                            </div>
                            <div class="timer-text-large" id="timer-text-large">残り 30秒</div>
                        </div>
                        <p class="browser-warning">
                            必ずChromeあるいはEdgeで接続してください。Safari等には対応していません
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">接続手順</h3>
                    <div class="connection-steps-container">
                        <div class="steps-content">
                            <ol class="connection-steps">
                                <li>QRコードからアクセス</li>
                                <li>画面からPCを選択</li>
                                <li>ワンタイムパスキーを入力</li>
                            </ol>
                        </div>
                        <div class="steps-qr">
                            <img src="hostsqr.png" class="qr-code">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">接続済みのデバイス</h3>
                    <div class="device-list">
                        <div class="device-item">
                            <div class="device-info">
                                <div class="device-name">iPhone 15 Pro</div>
                                <div class="device-status">接続中</div>
                            </div>
                            <button class="btn btn-danger btn-small">このデバイスを削除する</button>
                        </div>
                        <div class="device-item">
                            <div class="device-info">
                                <div class="device-name">iPad Air</div>
                                <div class="device-status">3日前に接続</div>
                            </div>
                            <button class="btn btn-danger btn-small">このデバイスを削除する</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">注意</h3>
                    <ul class="notice-list">
                        <li>
                            Chrome・Edgeのみ対応です
                        </li>
                        <li>Wi-Fiの接続先は同じにしてください</li>
                        <li>デバイス上ではタッチコントロールのみ有効です</li>
                    </ul>
                </div>
            </section>

            <!-- カスタマイズ -->
            <section class="content-section" id="customize">
                <h1 class="section-title">🛠️ カスタマイズ</h1>

                <div class="card">
                    <div class="coming-soon">
                        <h3>後日実装予定</h3>
                        <p>カスタマイズ機能は今後のアップデートで追加される予定です。</p>
                    </div>
                </div>
            </section>

            <!-- 設定 -->
            <section class="content-section" id="settings">
                <h1 class="section-title">⚙️ 設定</h1>

                <div class="card">
                    <h3 class="card-title" id="settings-system">システム</h3>
                    <div class="form-group">
                        <label class="form-label">
                            Windowsのスタートアップ時に起動する
                            <label class="toggle-switch">
                                <input type="checkbox" name="run_on_startup">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            起動時にウィンドウを表示する
                            <label class="toggle-switch">
                                <input type="checkbox" name="show_window_on_start">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title" id="settings-application">アプリケーション</h3>
                    <div class="form-group">
                        <label class="form-label">
                            自動アップデートを有効にする
                            <label class="toggle-switch">
                                <input type="checkbox" name="enable_auto_update">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            異常時に自動で再起動する
                            <label class="toggle-switch">
                                <input type="checkbox" name="auto_restart_on_error">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title" id="settings-notification">通知</h3>
                    <div class="form-group">
                        <label class="form-label">
                            デスクトップ通知を有効にする
                            <label class="toggle-switch">
                                <input type="checkbox" id="notification-master">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="notification-sub-settings" id="notification-sub-settings">
                        <div class="form-group sub-setting">
                            <label class="form-label">
                                認証要求時
                                <label class="toggle-switch">
                                    <input type="checkbox" class="notification-sub">
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="form-group sub-setting">
                            <label class="form-label">
                                デバイス接続時
                                <label class="toggle-switch">
                                    <input type="checkbox" class="notification-sub">
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="form-group sub-setting">
                            <label class="form-label">
                                デバイス切断時
                                <label class="toggle-switch">
                                    <input type="checkbox" class="notification-sub">
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                    </div>
                </div>
            </section>

            <!-- リリースノート -->
            <section class="content-section" id="release">
                <h1 class="section-title">📝 リリースノート</h1>

                <div class="card">
                    <h3 class="card-title">現在のアプリケーションバージョン</h3>
                    <div class="current-version">v2.1.0</div>
                </div>

                <div class="card">
                    <h3 class="card-title">最新のリリースノート</h3>
                    <div class="release-item">
                        <div class="release-header">
                            <span class="release-version">v2.1.0</span>
                            <span class="release-date">2024-01-15</span>
                        </div>
                        <div class="release-content">
                            <h4>新機能</h4>
                            <ul>
                                <li>ワンタイムパスキー認証システムの追加</li>
                                <li>デバイス接続状態のリアルタイム表示</li>
                                <li>RTT（応答時間）監視機能</li>
                            </ul>
                            <h4>改善</h4>
                            <ul>
                                <li>接続の安定性向上</li>
                                <li>UI/UXの改善</li>
                            </ul>
                            <h4>修正</h4>
                            <ul>
                                <li>Wi-Fi切り替え時の接続問題を修正</li>
                                <li>メモリリークの問題を解決</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">更新設定</h3>
                    <p class="update-status">
                        自動アップデートは<strong>有効</strong>になっています
                        <a href="#" onclick="showSettingsSection()" class="settings-link">設定を変更</a>
                    </p>
                    <a href="https://github.com/KoralMint/RemotePhone/releases" target="_blank"
                        class="btn btn-secondary">
                        GitHub Releasesページを開く
                    </a>
                </div>
            </section>
        </main>
    </div>

    <script>

        const SERVER_URL = "http://skyboxx.tplinkdns.com:8000";

        window.addEventListener('pywebviewready', async function () {
            console.log('initializing app...');
            // --- ホーム画面のデータ取得 ---
            async function updateHomeStatus() {
                // デバイス接続状態
                const device = await pywebview.api.home.get_device_connection_status();
                if (device.status === 'connected') {
                    document.getElementById('disconnected-state').style.display = 'none';
                    document.getElementById('connected-state').style.display = 'block';
                    document.querySelector('#connected-state .device-name').textContent = device.device_name;
                    document.querySelector('#connected-state .rtt-value').textContent = device.rtt;
                    document.querySelector('#connected-state .connection-time').textContent = `接続時間: ${device.since}`;
                } else {
                    document.getElementById('disconnected-state').style.display = 'block';
                    document.getElementById('connected-state').style.display = 'none';
                }

                // サーバー接続状況
                const server = await pywebview.api.home.get_server_connection_status();
                const statusDot = document.querySelector('.status-dot');
                const statusText = document.querySelector('.server-info .status-text');
                statusDot.className = 'status-dot';
                if (server.status === 'ok') {
                    statusDot.classList.add('status-normal');
                    statusText.textContent = '正常';
                } else if (server.status === 'warn') {
                    statusDot.classList.add('status-warn');
                    statusText.textContent = '警告';
                } else {
                    statusDot.classList.add('status-critical');
                    statusText.textContent = '異常';
                }

                // 接続方法
                const comm = await pywebview.api.home.get_communication_methods();
                document.querySelectorAll('.method-option').forEach(opt => {
                    const name = opt.querySelector('.method-name').textContent.toLowerCase();
                    opt.classList.remove('selected', 'disabled');
                    if (!comm.available.includes(name)) opt.classList.add('disabled');
                    if (comm.selected === name) opt.classList.add('selected');
                });
            }

            // 接続方法の選択
            document.querySelectorAll('.method-option').forEach(opt => {
                opt.addEventListener('click', async function () {
                    if (this.classList.contains('disabled')) return;
                    const name = this.querySelector('.method-name').textContent.toLowerCase();
                    await pywebview.api.home.set_prefered_communication_method(name);
                    await updateHomeStatus();
                });
            });

            // --- デバイス接続画面 ---
            async function updatePasskey() {
                const res = await pywebview.api.connect.get_current_passkey();
                document.getElementById('large-passkey').textContent = res.passkey;
                document.getElementById('timer-text-large').textContent = `残り ${res.remain}秒`;
                document.getElementById('timer-progress-large').style.width = (res.remain / 30 * 100) + '%';
            }
            setInterval(updatePasskey, 1000);
            updatePasskey();

            async function updateRegisteredDevices() {
                const list = await pywebview.api.connect.get_registered_devices();
                const container = document.querySelector('.device-list');
                container.innerHTML = '';
                list.forEach(dev => {
                    const el = document.createElement('div');
                    el.className = 'device-item';
                    el.innerHTML = `
                <div class="device-info">
                    <div class="device-name">${dev.name}</div>
                    <div class="device-status">${dev.last_connection === 0 ? '接続中' : dev.last_connection + '分前に接続'}</div>
                </div>
                <button class="btn btn-danger btn-small" data-uuid="${dev.uuid}">このデバイスを削除する</button>
            `;
                    container.appendChild(el);
                });
                container.querySelectorAll('.btn-danger').forEach(btn => {
                    btn.onclick = async function () {
                        if (confirm('このデバイスを削除しますか？')) {
                            await pywebview.api.connect.delete_registered_device(this.dataset.uuid);
                            updateRegisteredDevices();
                        }
                    };
                });
            }
            updateRegisteredDevices();

            // --- 設定 ---
            async function updateSettings() {
                // 設定を一括取得
                const settings = await pywebview.api.settings.get_settings();
                // システム
                document.querySelector('input[type=checkbox][name=run_on_startup]').checked = settings.system.run_on_startup;
                document.querySelector('input[type=checkbox][name=show_window_on_start]').checked = settings.system.show_window_on_start;
                // アプリ
                document.querySelector('input[type=checkbox][name=enable_auto_update]').checked = settings.application.enable_auto_update;
                document.querySelector('input[type=checkbox][name=auto_restart_on_error]').checked = settings.application.auto_restart_on_error;
                // 通知
                document.getElementById('notification-master').checked = settings.notification.enable_desktop_notification;
                document.querySelectorAll('.notification-sub')[0].checked = settings.notification.notify_authentication_request;
                document.querySelectorAll('.notification-sub')[1].checked = settings.notification.notify_device_connect;
                document.querySelectorAll('.notification-sub')[2].checked = settings.notification.notify_device_disconnect;
            }
            updateSettings();

            // 設定変更時
            document.querySelectorAll('.toggle-switch input').forEach(input => {
                input.addEventListener('change', async function () {
                    // すべての設定値をまとめて取得し、APIに渡す
                    await pywebview.api.settings.set_settings({
                        system: {
                            run_on_startup: document.querySelector('input[name=run_on_startup]').checked,
                            show_window_on_start: document.querySelector('input[name=show_window_on_start]').checked
                        },
                        application: {
                            enable_auto_update: document.querySelector('input[name=enable_auto_update]').checked,
                            auto_restart_on_error: document.querySelector('input[name=auto_restart_on_error]').checked
                        },
                        notification: {
                            enable_desktop_notification: document.getElementById('notification-master').checked,
                            notify_authentication_request: document.querySelectorAll('.notification-sub')[0].checked,
                            notify_device_connect: document.querySelectorAll('.notification-sub')[1].checked,
                            notify_device_disconnect: document.querySelectorAll('.notification-sub')[2].checked
                        }
                    });
                });
            });

            // --- リリースノート ---
            async function updateReleaseNote() {
                // バージョン
                const ver = await pywebview.api.release.get_current_application_version();
                document.querySelector('.current-version').textContent = ver.version;
                // 最新リリースノート
                const notes = await fetch('https://api.github.com/repos/KoralMint/RemotePhone/releases').then(r => r.json());
                if (notes.length > 0) {
                    const latest = notes[0];
                    document.querySelector('.release-version').textContent = latest.tag_name;
                    document.querySelector('.release-date').textContent = latest.published_at.split('T')[0];
                    document.querySelector('.release-content ul').innerHTML = latest.body.split('\n').map(line => `<li>${line}</li>`).join('');
                }
            }
            updateReleaseNote();

            // タブ切り替え時に各セクションのデータ再取得
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function () {
                    const section = this.getAttribute('data-section');
                    if (section === 'home') updateHomeStatus();
                    if (section === 'connect') { updatePasskey(); updateRegisteredDevices(); }
                    if (section === 'settings') updateSettings();
                    if (section === 'release') updateReleaseNote();
                });
            });

            // 初期化
            updateHomeStatus();
        });

        // タブ切り替え機能
    const navItems = document.querySelectorAll('.nav-item');
    const contentSections = document.querySelectorAll('.content-section');
    
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            const targetSection = this.getAttribute('data-section');

            // アクティブなナビゲーションアイテムを更新
            navItems.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');

            // アクティブなコンテンツセクションを更新
            contentSections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(targetSection).classList.add('active');
        });
    });
    </script>
</body>

</html>